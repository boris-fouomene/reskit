# üåç I18n Module - @resk/nest/i18n

> **Internationalization support for multi-language applications with dynamic locale switching**

## üìñ Overview

The I18n module provides comprehensive internationalization capabilities for @resk/nest applications. It offers automatic locale detection, dynamic namespace loading, middleware and interceptor support, and seamless integration with the @resk/core i18n system.

---

## üöÄ Quick Start

### **Installation & Setup**

```bash
npm install @resk/nest @resk/core
```

```typescript
import { Module, MiddlewareConsumer } from '@nestjs/common';
import { I18nModule, I18nMiddleware } from '@resk/nest/i18n';

@Module({
  imports: [
    I18nModule.forRoot({
      namespaces: {
        'common': (locale: string) => import(`./locales/${locale}/common`),
        'auth': (locale: string) => import(`./locales/${locale}/auth`),
        'errors': (locale: string) => import(`./locales/${locale}/errors`),
      },
      locales: ['en', 'fr', 'es', 'de'],
      global: true,
    }),
  ],
})
export class AppModule {
  configure(consumer: MiddlewareConsumer) {
    consumer.apply(I18nMiddleware).forRoutes('*');
  }
}
```

### **Basic Usage in Controller**

```typescript
import { Controller, Get, Inject } from '@nestjs/common';
import { I18n } from '@resk/core/i18n';

@Controller('api')
export class AppController {
  constructor(@Inject('I18N') private readonly i18n: I18n) {}

  @Get('welcome')
  async getWelcome(): Promise<{ message: string; locale: string }> {
    const message = await this.i18n.t('common.welcome', { name: 'John' });
    const locale = this.i18n.getLocale();
    
    return { message, locale };
  }

  @Get('profile')
  async getUserProfile(): Promise<any> {
    return {
      title: await this.i18n.t('common.profile.title'),
      labels: {
        name: await this.i18n.t('common.profile.labels.name'),
        email: await this.i18n.t('common.profile.labels.email'),
        phone: await this.i18n.t('common.profile.labels.phone'),
      },
      messages: {
        updated: await this.i18n.t('common.profile.messages.updated'),
        error: await this.i18n.t('common.profile.messages.error'),
      }
    };
  }
}
```

---

## üèóÔ∏è Core Components

### **I18nModule**

```typescript
/**
 * Dynamic NestJS module for internationalization management
 */
export class I18nModule {
  static forRoot(options?: {
    // Namespace resolvers for dynamic loading
    namespaces?: { 
      [key: string]: (locale: string) => Promise<any> 
    };
    
    // Static translations to load immediately
    translations?: II18nTranslation | II18nTranslation[];
    
    // Create new I18n instance or use global
    createNewInstance?: boolean;
    
    // Make module global-scoped
    global?: boolean;
    
    // List of supported locales
    locales?: string[];
  }): DynamicModule;
}
```

### **I18nMiddleware**

```typescript
/**
 * Middleware for automatic locale detection and setting
 */
@Injectable()
export class I18nMiddleware implements NestMiddleware {
  constructor(@Inject("I18N") private readonly i18n: I18n) {}
  
  async use(req: Request, res: Response, next: NextFunction): Promise<void>;
}
```

### **I18nInterceptor**

```typescript
/**
 * Interceptor for request-scoped locale handling
 */
@Injectable()
export class I18nInterceptor implements NestInterceptor {
  constructor(@Inject("I18N") private readonly i18n: I18n) {}
  
  async intercept(context: ExecutionContext, next: CallHandler): Promise<Observable<any>>;
}
```

---

## üìÅ Translation Files Structure

### **Locale Files Organization**

```
src/
‚îú‚îÄ‚îÄ locales/
‚îÇ   ‚îú‚îÄ‚îÄ en/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ errors.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validation.ts
‚îÇ   ‚îú‚îÄ‚îÄ fr/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ errors.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validation.ts
‚îÇ   ‚îú‚îÄ‚îÄ es/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ de/
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ app.module.ts
‚îî‚îÄ‚îÄ main.ts
```

### **Translation File Examples**

```typescript
// src/locales/en/common.ts
export default {
  welcome: "Welcome, {name}!",
  goodbye: "Goodbye!",
  navigation: {
    home: "Home",
    about: "About",
    contact: "Contact",
    services: "Services"
  },
  profile: {
    title: "User Profile",
    labels: {
      name: "Full Name",
      email: "Email Address",
      phone: "Phone Number",
      address: "Address"
    },
    messages: {
      updated: "Profile updated successfully",
      error: "Failed to update profile",
      notFound: "Profile not found"
    }
  },
  buttons: {
    save: "Save",
    cancel: "Cancel",
    delete: "Delete",
    edit: "Edit",
    submit: "Submit"
  },
  pagination: {
    previous: "Previous",
    next: "Next",
    page: "Page {current} of {total}",
    showing: "Showing {start} to {end} of {total} results"
  }
};

// src/locales/fr/common.ts
export default {
  welcome: "Bienvenue, {name}!",
  goodbye: "Au revoir!",
  navigation: {
    home: "Accueil",
    about: "√Ä propos",
    contact: "Contact",
    services: "Services"
  },
  profile: {
    title: "Profil Utilisateur",
    labels: {
      name: "Nom Complet",
      email: "Adresse Email",
      phone: "Num√©ro de T√©l√©phone",
      address: "Adresse"
    },
    messages: {
      updated: "Profil mis √† jour avec succ√®s",
      error: "√âchec de la mise √† jour du profil",
      notFound: "Profil non trouv√©"
    }
  },
  buttons: {
    save: "Enregistrer",
    cancel: "Annuler",
    delete: "Supprimer",
    edit: "Modifier",
    submit: "Soumettre"
  },
  pagination: {
    previous: "Pr√©c√©dent",
    next: "Suivant",
    page: "Page {current} sur {total}",
    showing: "Affichage de {start} √† {end} sur {total} r√©sultats"
  }
};
```

```typescript
// src/locales/en/auth.ts
export default {
  login: {
    title: "Sign In",
    subtitle: "Welcome back! Please sign in to your account",
    fields: {
      email: "Email",
      password: "Password",
      remember: "Remember me"
    },
    buttons: {
      signin: "Sign In",
      signup: "Sign Up",
      forgot: "Forgot Password?"
    },
    messages: {
      success: "Successfully signed in",
      error: "Invalid credentials",
      locked: "Account locked. Please try again later",
      expired: "Session expired. Please sign in again"
    }
  },
  register: {
    title: "Create Account",
    subtitle: "Join us today! Create your account to get started",
    fields: {
      name: "Full Name",
      email: "Email Address",
      password: "Password",
      confirm: "Confirm Password",
      terms: "I agree to the Terms and Conditions"
    },
    buttons: {
      create: "Create Account",
      signin: "Already have an account? Sign In"
    },
    messages: {
      success: "Account created successfully",
      exists: "Account already exists",
      weak: "Password is too weak"
    }
  },
  validation: {
    required: "{field} is required",
    email: "Please enter a valid email address",
    min: "{field} must be at least {min} characters",
    max: "{field} must not exceed {max} characters",
    match: "Passwords do not match"
  }
};

// src/locales/en/errors.ts
export default {
  http: {
    400: "Bad Request",
    401: "Unauthorized",
    403: "Forbidden",
    404: "Not Found",
    422: "Validation Error",
    500: "Internal Server Error"
  },
  validation: {
    required: "This field is required",
    invalid: "Invalid value provided",
    format: "Invalid format",
    length: "Invalid length"
  },
  database: {
    connection: "Database connection failed",
    notFound: "Record not found",
    duplicate: "Duplicate entry",
    constraint: "Constraint violation"
  },
  auth: {
    unauthorized: "Access denied",
    expired: "Token expired",
    invalid: "Invalid token",
    insufficient: "Insufficient permissions"
  }
};
```

---

## üîß Configuration Options

### **Module Configuration**

```typescript
// Basic configuration
@Module({
  imports: [
    I18nModule.forRoot({
      namespaces: {
        'common': (locale: string) => import(`./locales/${locale}/common`),
        'auth': (locale: string) => import(`./locales/${locale}/auth`),
      },
      locales: ['en', 'fr', 'es'],
      global: true,
    }),
  ],
})
export class AppModule {}

// Advanced configuration with static translations
@Module({
  imports: [
    I18nModule.forRoot({
      // Dynamic namespace loading
      namespaces: {
        'common': (locale: string) => import(`./locales/${locale}/common`),
        'auth': (locale: string) => import(`./locales/${locale}/auth`),
        'errors': (locale: string) => import(`./locales/${locale}/errors`),
      },
      
      // Static translations (loaded immediately)
      translations: [
        {
          en: {
            app: {
              name: "My Application",
              version: "1.0.0"
            }
          },
          fr: {
            app: {
              name: "Mon Application",
              version: "1.0.0"
            }
          }
        }
      ],
      
      // Supported locales
      locales: ['en', 'fr', 'es', 'de', 'it', 'pt'],
      
      // Create new I18n instance (isolate from global)
      createNewInstance: true,
      
      // Make module available globally
      global: true,
    }),
  ],
})
export class AppModule {}

// Multiple I18n instances for different modules
@Module({
  imports: [
    // Global I18n instance
    I18nModule.forRoot({
      namespaces: {
        'common': (locale: string) => import(`./locales/${locale}/common`),
      },
      global: true,
    }),
    
    // Admin-specific I18n instance
    I18nModule.forRoot({
      namespaces: {
        'admin': (locale: string) => import(`./admin/locales/${locale}/admin`),
      },
      createNewInstance: true,
      locales: ['en', 'fr'],
    }),
  ],
})
export class AppModule {}
```

---

## üåê Middleware & Interceptor Usage

### **Middleware Setup (Global)**

```typescript
import { Module, MiddlewareConsumer, RequestMethod } from '@nestjs/common';
import { I18nMiddleware } from '@resk/nest/i18n';

@Module({
  imports: [
    I18nModule.forRoot({
      namespaces: {
        'common': (locale: string) => import(`./locales/${locale}/common`),
      },
      locales: ['en', 'fr', 'es'],
    }),
  ],
})
export class AppModule {
  configure(consumer: MiddlewareConsumer) {
    // Apply to all routes
    consumer.apply(I18nMiddleware).forRoutes('*');
    
    // Or apply to specific routes
    consumer
      .apply(I18nMiddleware)
      .forRoutes(
        { path: 'api/*', method: RequestMethod.ALL },
        { path: 'admin/*', method: RequestMethod.ALL }
      );
  }
}
```

### **Interceptor Setup (Global)**

```typescript
import { Module } from '@nestjs/common';
import { APP_INTERCEPTOR } from '@nestjs/core';
import { I18nInterceptor } from '@resk/nest/i18n';

@Module({
  imports: [
    I18nModule.forRoot({
      namespaces: {
        'common': (locale: string) => import(`./locales/${locale}/common`),
      },
    }),
  ],
  providers: [
    {
      provide: APP_INTERCEPTOR,
      useClass: I18nInterceptor,
    },
  ],
})
export class AppModule {}
```

### **Controller-Specific Interceptor**

```typescript
import { Controller, Get, UseInterceptors } from '@nestjs/common';
import { I18nInterceptor } from '@resk/nest/i18n';

@Controller('api')
@UseInterceptors(I18nInterceptor)
export class ApiController {
  @Get('data')
  async getData() {
    // Locale is automatically set by interceptor
    return { message: await this.i18n.t('common.welcome') };
  }
}
```

---

## üéØ Service Implementation

### **Translation Service**

```typescript
import { Injectable, Inject } from '@nestjs/common';
import { I18n } from '@resk/core/i18n';

@Injectable()
export class TranslationService {
  constructor(@Inject('I18N') private readonly i18n: I18n) {}

  // Get current locale
  getCurrentLocale(): string {
    return this.i18n.getLocale();
  }

  // Check if locale is supported
  isLocaleSupported(locale: string): boolean {
    return this.i18n.hasLocale(locale);
  }

  // Translate with namespace
  async translate(key: string, params?: any, namespace?: string): Promise<string> {
    if (namespace) {
      return this.i18n.t(`${namespace}.${key}`, params);
    }
    return this.i18n.t(key, params);
  }

  // Get all translations for current locale
  async getAllTranslations(namespace?: string): Promise<any> {
    const locale = this.getCurrentLocale();
    
    if (namespace) {
      return this.i18n.getNamespaceTranslations(namespace, locale);
    }
    
    return this.i18n.getAllTranslations(locale);
  }

  // Set locale manually
  async setLocale(locale: string): Promise<void> {
    if (this.isLocaleSupported(locale)) {
      await this.i18n.setLocale(locale);
    } else {
      throw new Error(`Locale '${locale}' is not supported`);
    }
  }

  // Format currency with locale
  formatCurrency(amount: number, currency: string = 'USD'): string {
    const locale = this.getCurrentLocale();
    return new Intl.NumberFormat(locale, {
      style: 'currency',
      currency: currency,
    }).format(amount);
  }

  // Format date with locale
  formatDate(date: Date, options?: Intl.DateTimeFormatOptions): string {
    const locale = this.getCurrentLocale();
    return new Intl.DateTimeFormat(locale, options).format(date);
  }

  // Format number with locale
  formatNumber(number: number, options?: Intl.NumberFormatOptions): string {
    const locale = this.getCurrentLocale();
    return new Intl.NumberFormat(locale, options).format(number);
  }
}

// Usage in controller
@Controller('api')
export class ApiController {
  constructor(private readonly translationService: TranslationService) {}

  @Get('user/:id')
  async getUser(@Param('id') id: string) {
    const user = await this.userService.findById(id);
    
    return {
      ...user,
      displayName: await this.translationService.translate('user.displayName', { name: user.name }),
      joinDate: this.translationService.formatDate(user.createdAt, { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      }),
      balance: this.translationService.formatCurrency(user.balance),
    };
  }

  @Post('locale')
  async setLocale(@Body('locale') locale: string) {
    await this.translationService.setLocale(locale);
    
    return {
      message: await this.translationService.translate('common.localeChanged'),
      locale: this.translationService.getCurrentLocale(),
    };
  }
}
```

### **Validation Messages Service**

```typescript
import { Injectable, Inject } from '@nestjs/common';
import { I18n } from '@resk/core/i18n';

@Injectable()
export class ValidationMessageService {
  constructor(@Inject('I18N') private readonly i18n: I18n) {}

  async getValidationMessage(rule: string, field: string, params?: any): Promise<string> {
    const key = `validation.${rule}`;
    const defaultParams = { field, ...params };
    
    try {
      return await this.i18n.t(key, defaultParams);
    } catch (error) {
      // Fallback to generic message
      return await this.i18n.t('validation.invalid', { field });
    }
  }

  async getFormValidationMessages(errors: any[]): Promise<{ [key: string]: string[] }> {
    const messages: { [key: string]: string[] } = {};
    
    for (const error of errors) {
      const field = error.property;
      const constraints = error.constraints || {};
      
      messages[field] = await Promise.all(
        Object.keys(constraints).map(async (rule) => {
          return this.getValidationMessage(rule, field, error.value);
        })
      );
    }
    
    return messages;
  }
}

// Custom validation decorator with i18n
import { registerDecorator, ValidationOptions, ValidationArguments } from 'class-validator';

export function IsLocalizedString(validationOptions?: ValidationOptions) {
  return function (object: Object, propertyName: string) {
    registerDecorator({
      name: 'isLocalizedString',
      target: object.constructor,
      propertyName: propertyName,
      options: validationOptions,
      validator: {
        validate(value: any, args: ValidationArguments) {
          return typeof value === 'string' && value.length > 0;
        },
        defaultMessage(args: ValidationArguments) {
          // This will be replaced by i18n message
          return `${args.property} must be a valid string`;
        },
      },
    });
  };
}
```

---

## üîÑ Dynamic Locale Switching

### **Locale Detection & Switching**

```typescript
import { Injectable, Inject } from '@nestjs/common';
import { I18n } from '@resk/core/i18n';

@Injectable()
export class LocaleService {
  constructor(@Inject('I18N') private readonly i18n: I18n) {}

  // Detect locale from various sources
  async detectLocale(request: any): Promise<string> {
    // 1. Check query parameter
    const queryLocale = request.query?.locale || request.query?.lang;
    if (queryLocale && this.i18n.hasLocale(queryLocale)) {
      return queryLocale;
    }

    // 2. Check custom header
    const headerLocale = request.headers['x-locale'] || request.headers['x-language'];
    if (headerLocale && this.i18n.hasLocale(headerLocale)) {
      return headerLocale;
    }

    // 3. Check Accept-Language header
    const acceptLanguage = request.headers['accept-language'];
    if (acceptLanguage) {
      const preferredLocale = this.parseAcceptLanguage(acceptLanguage);
      if (preferredLocale && this.i18n.hasLocale(preferredLocale)) {
        return preferredLocale;
      }
    }

    // 4. Check user preferences (if authenticated)
    if (request.user?.preferredLocale) {
      const userLocale = request.user.preferredLocale;
      if (this.i18n.hasLocale(userLocale)) {
        return userLocale;
      }
    }

    // 5. Check cookie
    const cookieLocale = request.cookies?.locale;
    if (cookieLocale && this.i18n.hasLocale(cookieLocale)) {
      return cookieLocale;
    }

    // 6. Default to 'en'
    return 'en';
  }

  private parseAcceptLanguage(acceptLanguage: string): string | null {
    // Parse "en-US,en;q=0.9,fr;q=0.8" format
    const languages = acceptLanguage
      .split(',')
      .map(lang => {
        const [locale, q = 'q=1'] = lang.trim().split(';');
        return {
          locale: locale.split('-')[0], // Get primary language
          quality: parseFloat(q.split('=')[1]) || 1
        };
      })
      .sort((a, b) => b.quality - a.quality);

    return languages.find(lang => this.i18n.hasLocale(lang.locale))?.locale || null;
  }

  // Custom middleware that uses LocaleService
  createLocaleMiddleware() {
    return async (req: any, res: any, next: any) => {
      const detectedLocale = await this.detectLocale(req);
      await this.i18n.setLocale(detectedLocale);
      
      // Add locale info to request for later use
      req.locale = detectedLocale;
      req.isRTL = this.isRTLLocale(detectedLocale);
      
      next();
    };
  }

  private isRTLLocale(locale: string): boolean {
    const rtlLocales = ['ar', 'he', 'fa', 'ur'];
    return rtlLocales.includes(locale);
  }
}

// Controller for locale management
@Controller('api/locale')
export class LocaleController {
  constructor(
    private readonly localeService: LocaleService,
    @Inject('I18N') private readonly i18n: I18n
  ) {}

  @Get('current')
  getCurrentLocale() {
    return {
      locale: this.i18n.getLocale(),
      isRTL: this.localeService.isRTLLocale(this.i18n.getLocale()),
    };
  }

  @Get('supported')
  getSupportedLocales() {
    return {
      locales: this.i18n.getAvailableLocales(),
      current: this.i18n.getLocale(),
    };
  }

  @Post('switch')
  async switchLocale(@Body('locale') locale: string, @Res() response: any) {
    if (!this.i18n.hasLocale(locale)) {
      throw new BadRequestException('Unsupported locale');
    }

    await this.i18n.setLocale(locale);

    // Set cookie for future requests
    response.cookie('locale', locale, {
      maxAge: 365 * 24 * 60 * 60 * 1000, // 1 year
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
    });

    return {
      message: await this.i18n.t('common.localeChanged'),
      locale: locale,
    };
  }
}
```

---

## üéØ Best Practices

### **1. Namespace Organization**
```typescript
// ‚úÖ Good: Organize by feature/domain
namespaces: {
  'common': (locale) => import(`./locales/${locale}/common`),
  'auth': (locale) => import(`./locales/${locale}/auth`),
  'user': (locale) => import(`./locales/${locale}/user`),
  'admin': (locale) => import(`./locales/${locale}/admin`),
}

// ‚úÖ Good: Use consistent key structure
export default {
  forms: {
    labels: { /* ... */ },
    messages: { /* ... */ },
    validation: { /* ... */ }
  }
};
```

### **2. Translation Keys**
```typescript
// ‚úÖ Good: Use descriptive, hierarchical keys
'user.profile.edit.success'
'auth.login.validation.email.required'
'common.buttons.save'

// ‚ùå Avoid: Flat, unclear keys
'msg1'
'error_login'
'btn_save'
```

### **3. Parameter Usage**
```typescript
// ‚úÖ Good: Use named parameters
welcome: "Welcome back, {userName}!"
await this.i18n.t('welcome', { userName: 'John' });

// ‚úÖ Good: Pluralization support
items: {
  zero: "No items",
  one: "1 item", 
  other: "{count} items"
}
```

---

The I18n module provides complete internationalization support with automatic locale detection, dynamic loading, and seamless integration for building multi-language applications.
