# DOM-Safe ID Sanitization for React useId Hook

This utility provides a comprehensive solution for sanitizing IDs generated by React's `useId()` hook to make them safe for use in DOM selectors like `querySelector`, CSS selectors, and other DOM APIs.

## The Problem

React's `useId()` hook generates unique IDs like `:r1:`, `:R2d6:`, or `:r123abc:` which contain colons (`:`) and other characters that are valid in HTML but problematic when used in CSS selectors. When you try to use these IDs with `querySelector`, you'll encounter errors like:

```javascript
const id = useId(); // Returns ":r1:"
const element = document.querySelector(`#${id}`); // ❌ Error: Invalid selector
```

This happens because colons (`:`) have special meaning in CSS selectors (pseudo-classes like `:hover`, `:focus`, etc.).

## The Solution

The `sanitizeReactId()` function converts problematic characters to safe alternatives while preserving uniqueness and readability.

### Character Mapping

| Character | Replacement | Meaning |
|-----------|-------------|---------|
| `:` | `_c_` | colon |
| `@` | `_at_` | at sign |
| `#` | `_h_` | hash |
| `.` | `_d_` | dot |
| `[` | `_lb_` | left bracket |
| `]` | `_rb_` | right bracket |
| `(` | `_lp_` | left parenthesis |
| `)` | `_rp_` | right parenthesis |
| ` ` | `_s_` | space |
| `+` | `_plus_` | plus |
| `~` | `_t_` | tilde |
| `>` | `_gt_` | greater than |
| `<` | `_lt_` | less than |
| `=` | `_eq_` | equals |
| `*` | `_star_` | asterisk |
| `^` | `_car_` | caret |
| `$` | `_dol_` | dollar |
| `|` | `_p_` | pipe |
| `&` | `_amp_` | ampersand |
| `!` | `_ex_` | exclamation |
| `?` | `_q_` | question |
| `%` | `_per_` | percent |
| `"` | `_dq_` | double quote |
| `'` | `_sq_` | single quote |
| `;` | `_sc_` | semicolon |
| `,` | `_com_` | comma |
| `/` | `_fs_` | forward slash |
| `\` | `_bs_` | backslash |

## Usage

### Basic Usage

```typescript
import { useSafeId, sanitizeReactId } from '@resk/nativewind/hooks/useSafeId';

function MyComponent() {
  // Using the hook (recommended)
  const safeId = useSafeId('button');
  
  // Or sanitize manually
  const reactId = useId();
  const manualSafeId = sanitizeReactId(reactId, 'input');
  
  return (
    <div>
      <button id={safeId}>Safe Button</button>
      <input id={manualSafeId} />
    </div>
  );
}
```

### Before and After Examples

```typescript
// ❌ Before: Using raw useId() output
const rawId = useId(); // ":r1:"
const element = document.querySelector(`#${rawId}`); // Error!

// ✅ After: Using sanitized ID
const safeId = useSafeId('btn'); // "btn_c_r1_c_"
const element = document.querySelector(`#${safeId}`); // Works perfectly!
```

### Real-world Form Example

```typescript
import { useSafeId } from '@resk/nativewind/hooks/useSafeId';

function ContactForm() {
  const formId = useSafeId('contact-form');
  const nameInputId = useSafeId('name-input');
  const nameLabelId = useSafeId('name-label');
  const nameErrorId = useSafeId('name-error');
  const emailInputId = useSafeId('email-input');
  
  const handleSubmit = () => {
    // All these selectors will work reliably
    const form = document.querySelector(`#${formId}`);
    const nameInput = document.querySelector(`#${nameInputId}`);
    const emailInput = document.querySelector(`#${emailInputId}`);
    
    // Perform validation, focus management, etc.
  };
  
  return (
    <form id={formId} onSubmit={handleSubmit}>
      <div>
        <label id={nameLabelId} htmlFor={nameInputId}>
          Name
        </label>
        <input 
          id={nameInputId}
          aria-labelledby={nameLabelId}
          aria-describedby={nameErrorId}
        />
        <div id={nameErrorId} role="alert">
          Error message
        </div>
      </div>
      
      <div>
        <label htmlFor={emailInputId}>Email</label>
        <input id={emailInputId} type="email" />
      </div>
      
      <button type="submit">Submit</button>
    </form>
  );
}
```

### Multiple IDs Hook

```typescript
import { useSafeIds } from '@resk/nativewind/hooks/useSafeId';

function ModalComponent() {
  // Generate multiple related IDs at once
  const ids = useSafeIds(['modal', 'title', 'content', 'close-btn']);
  
  useEffect(() => {
    // All selectors work perfectly
    const modal = document.querySelector(`#${ids.modal}`);
    const title = document.querySelector(`#${ids.title}`);
    const closeBtn = document.querySelector(`#${ids['close-btn']}`);
    
    // Set up event listeners, focus management, etc.
  }, [ids]);
  
  return (
    <div id={ids.modal} role="dialog" aria-labelledby={ids.title}>
      <h2 id={ids.title}>Modal Title</h2>
      <div id={ids.content}>
        Modal content goes here
      </div>
      <button id={ids['close-btn']}>Close</button>
    </div>
  );
}
```

### ARIA-Optimized IDs

```typescript
import { useAriaId } from '@resk/nativewind/hooks/useSafeId';

function AccessibleForm() {
  const labelId = useAriaId('label');
  const descriptionId = useAriaId('description');
  const errorId = useAriaId('error');
  
  return (
    <div>
      <label id={labelId}>Email Address</label>
      <input 
        aria-labelledby={labelId}
        aria-describedby={`${descriptionId} ${errorId}`}
      />
      <div id={descriptionId}>
        Enter your email address to receive updates
      </div>
      <div id={errorId} role="alert">
        Please enter a valid email address
      </div>
    </div>
  );
}
```

### Validation Hook

```typescript
import { useSafeIdWithValidation } from '@resk/nativewind/hooks/useSafeId';

function ComponentWithValidation() {
  const { id, isValid } = useSafeIdWithValidation('my-element');
  
  if (!isValid) {
    console.warn('Generated ID may not work with all selectors:', id);
  }
  
  return <div id={id}>Content</div>;
}
```

## API Reference

### `sanitizeReactId(reactId: string, prefix?: string): string`

Sanitizes a React useId output for DOM selector safety.

- **reactId**: The ID string from React's useId()
- **prefix**: Optional prefix (default: "id")
- **Returns**: Sanitized ID safe for selectors

### `useSafeId(prefix?: string): string`

React hook that generates a sanitized ID.

- **prefix**: Optional prefix (default: "id")
- **Returns**: Sanitized ID safe for selectors

### `useSafeIds(prefixes: string[] | Record<string, string>)`

React hook that generates multiple sanitized IDs.

- **prefixes**: Array of prefixes or object mapping
- **Returns**: Object with sanitized IDs

### `useAriaId(type: AriaType, customPrefix?: string): string`

React hook for ARIA-optimized IDs.

- **type**: ARIA relationship type
- **customPrefix**: Optional custom prefix
- **Returns**: ARIA-optimized sanitized ID

### `useSafeIdWithValidation(prefix?: string, validate?: boolean)`

React hook with built-in validation.

- **prefix**: Optional prefix
- **validate**: Whether to validate (default: true)
- **Returns**: Object with ID and validation status

### `isValidDomId(id: string): boolean`

Validates if an ID is safe for DOM selectors.

- **id**: ID string to validate
- **Returns**: True if safe for selectors

## Migration Guide

### Updating Existing Code

```typescript
// ❌ Before
function OldComponent() {
  const id = useId();
  
  useEffect(() => {
    // This will fail!
    const element = document.querySelector(`#${id}`);
  }, [id]);
  
  return <div id={id}>Content</div>;
}

// ✅ After
function NewComponent() {
  const id = useSafeId('content');
  
  useEffect(() => {
    // This works reliably!
    const element = document.querySelector(`#${id}`);
  }, [id]);
  
  return <div id={id}>Content</div>;
}
```

### Fixing Existing Issues

If you're currently using CSS.escape() or manual string replacement:

```typescript
// ❌ Old workaround
const id = useId();
const safeId = CSS.escape(id); // Browser-dependent
// or
const safeId = id.replace(/:/g, ''); // Loses readability

// ✅ New solution
const safeId = useSafeId('element'); // Consistent, readable, safe
```

## Benefits

1. **Consistent**: Works across all browsers and environments
2. **Readable**: Maintains meaningful character representations
3. **Unique**: Preserves the uniqueness of React's useId
4. **Safe**: Guaranteed to work with all CSS selectors and DOM APIs
5. **Performant**: Minimal overhead with efficient string replacement
6. **Flexible**: Multiple hooks for different use cases

## Testing

Run the included test file to verify functionality:

```typescript
import { testSanitizeReactId, demonstrateUsage, performanceTest } from './useSafeId.test';

// Run all tests
testSanitizeReactId();
demonstrateUsage();
performanceTest();
```

## Common Use Cases

- ✅ `document.querySelector('#' + safeId)`
- ✅ `document.getElementById(safeId)`
- ✅ CSS targeting: `#${safeId} { ... }`
- ✅ ARIA relationships: `aria-labelledby={safeId}`
- ✅ Form associations: `htmlFor={safeId}`
- ✅ Event delegation: `event.target.id === safeId`
- ✅ Testing: `screen.getByTestId(safeId)`

This solution ensures your React components work reliably with DOM APIs while maintaining the benefits of React's built-in ID generation.
